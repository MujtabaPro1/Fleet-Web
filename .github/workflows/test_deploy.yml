name: Deploy to Production

on:
  push:
    branches:
      - test

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies (CI)
        run: npm ci --legacy-peer-deps

      - name: Build Next.js
        run: npm run build

      - name: Create deployment package
        run: |
          mkdir deploy
          rsync -av \
            --exclude=".git" \
            --exclude=".github" \
            --exclude="node_modules" \
            ./ ./deploy/

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.FLEET_STG_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.FLEET_STG_HOST }} >> ~/.ssh/known_hosts

      - name: Upload files to cPanel
        run: |
          rsync -avz ./deploy/ \
            ${{ secrets.FLEET_STG_USER }}@${{ secrets.FLEET_STG_HOST }}:/home/${{ secrets.FLEET_STG_USER }}/frontend-prod/

      - name: Install production dependencies + restart
        run: |
          ssh ${{ secrets.FLEET_STG_USER }}@${{ secrets.FLEET_STG_HOST }} << 'EOF'
            echo "ðŸš€ Starting deployment on cPanel..."

            cd /home/${{ secrets.FLEET_STG_USER }}/frontend-prod

            echo "ðŸŒ Activating Node.js environment"
            source /home/${{ secrets.FLEET_STG_USER }}/nodevenv/frontend-prod/20/bin/activate

            echo "ðŸ“¦ Installing production dependencies (no dev)"
            npm ci --omit=dev --legacy-peer-deps

            echo "ðŸ” Restarting app"
            mkdir -p tmp
            touch tmp/restart.txt

            echo "âœ… Deployment completed successfully!"
          EOF
